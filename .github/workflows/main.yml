name: Deploy Avalonia WASM to GitHub Pages

# 触发条件：当 master 分支有代码推送（push）时执行
on:
  push:
    branches: [ master ]

# 设置权限：允许 Action 向仓库写入内容（部署到 gh-pages 分支需要此权限）
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 下载源代码
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2. 安装 .NET SDK (指定为 10.0 版本)
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 3. 安装 WASM 本地工具链 (解决你之前遇到的 WasmBuildNative 问题)
      - name: Install WASM Tools
        run: dotnet workload install wasm-tools

      # 4. 发布项目
      # -c Release: 使用发布模式
      # -o release: 将结果输出到名为 release 的文件夹
      # 注意：请确保下方的路径指向你实际的 .Wasm.csproj 文件
      - name: Dotnet Publish
        run: dotnet publish PrismAvaloniaWithMSDI.Wasm/PrismAvaloniaWithMSDI.Wasm.csproj -c Release -o release

      # 5. 修正 GitHub Pages 路径 (非常重要！)
      # GitHub Pages 默认路径是 /仓库名/，而生成的 index.html 默认是 /
      # 如果不修改，会导致所有 JS/WASM 文件 404 无法加载
      - name: Fix Base Href for GitHub Pages
        run: |
          # 获取仓库名称 (例如: my-avalonia-app)
          REPOSITORY_NAME=$(echo $GITHUB_REPOSITORY | sed 's:.*/::')
          # 将 index.html 中的 <base href="/" /> 替换为 <base href="/仓库名/" />
          sed -i "s|<base href=\"/\" />|<base href=\"/$REPOSITORY_NAME/\" />|g" release/wwwroot/index.html
          # 创建 .nojekyll 文件，防止 GitHub 过滤掉以点号开头的文件夹（如 .managed）
          touch release/wwwroot/.nojekyll

      # 6. 部署到 gh-pages 分支
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: release/wwwroot # 告诉插件从哪个文件夹寻找要发布的文件
          branch: gh-pages        # 目标分支（如果不存在会自动创建）
          clean: true             # 每次部署前清理旧文件
